"""
顾问分析报告生成工具

提供顾问分析报告生成的相关工具函数
"""

import os
import time
from datetime import datetime
import requests


import markdown
try:
    from weasyprint import HTML  # type: ignore
    PDF_AVAILABLE = True
except ImportError:
    PDF_AVAILABLE = False

# AI眼镜销售二次分析提示词
SECONDARY_ANALYSIS_PROMPT = """
### **[ROLE]**

你是一位资深的销售数据科学家与行为分析专家。你的核心任务是为一位销售顾问全天的**量化指标**与**所有通话文本内容**进行全面的聚合分析与模式识别。你的分析**必须完全脱离对任何单次通话的引用**。

你的目标是提炼出该顾问在本日工作中反复出现的行为模式、技能习惯、沟通策略及其对业绩数据的宏观影响。最终，你需要生成一份结构化、专业且可直接呈现的**中文分析报告**。

原则：

- 所有分析必须基于数据证据，避免主观推断
- 分析逻辑与报告结构分离：先诊断→再呈现
- 输出内容必须专业、可执行





### **[INPUTS]**

1. **`{{consultant_daily_metrics}}`**: 该顾问的日度量化数据统计（中文）。
2. **`{{consultant_daily_calls}}`**: 该顾问一日内的**所有通话文本转写记录集合**。





### **[CORE_DIRECTIVE]**

**严格禁止分析或引用任何单次通话案例。** 你的唯一任务是**综合分析全部通话**，从整体上抽象出具有统计意义的模式和趋势。将 `{{consultant_daily_metrics}}` 的量化结果与从 `{{consultant_daily_calls}}` 中提炼出的定性行为模式进行深度关联，并根据 **[ANALYSIS_FRAMEWORK]** 和 **[OUTPUT_FORMAT]** 输出一份**Markdown格式的中文报告**。





### **[ANALYSIS_FRAMEWORK]**

*报告内容将严格遵循以下中文章节结构。*



### **第一部分：客观数据与行为模式洞察**

**1. 综合效能诊断**

- **1.1. 核心业绩看板:** 以表格形式清晰呈现当日核心数据。

| 指标名称                                      | 今日数据 |
| :-------------------------------------------- | :------- |
| 总通话数                                      |          |
| 接通数                                        |          |
| 接通率 （接通数/总通话数）                    |          |
| 有效通话率（通话录音>=15s/接通数）            |          |
| 平均有效通话时长（有效通话时长/有效通话次数） |          |
| 有效通话时长                                  |          |



- **1.2. 业绩归因分析: 多维诊断**

  - **1.2.1. 对话动态与主导权诊断 (沟通风格画像)**

    - **核心诊断:** 评估顾问是否符合公司定义的“进攻型”沟通模式，并判断其“进攻”的质量。
    - **顾问发言占比 (进攻性指标)**:聚合所有有效通话，计算顾问话语量占比（基于字数或句子数）的比例。此指标直接衡量顾问的对话主导意愿和进攻姿态。
      - **诊断方向 (基于 55%-65% 的目标区间)**:
        - **进攻型主导 (55% - 65%):** 主动掌控对话节奏。
        - **压迫式宣讲 (> 65%):** 输出过多，可能牺牲客户参与度。
        - **主导力不足 (< 55%):** 主导权不足，客户主导过多。
      - **提问-陈述比 (进攻有效性指标)**:基于通话文本，统计顾问使用疑问句与陈述句的比例。
        - **诊断方向**: 理想的“进攻型顾问”应在高密度陈述中，穿插**精准提问**来引导客户。

  - **1.2.2. 价值传递与客户共鸣诊断 (信息有效性检验)**

    - **客户共鸣的真实性诊断**:

      - 基于客户回应文本，区分 **礼貌性附和**（如“嗯”“了解”）与 **主动探究式提问**（如“这个具体怎么做？”）。

      **价值传递的逻辑驱动力分析**:

      - 判断顾问论述是 **由客户问题驱动**（回应痛点展开）还是 **由产品功能驱动**（按预设顺序介绍）。

  - **1.2.3. 流程阻力与异议点定位 (执行瓶颈分析)**

    - **关键议程覆盖率:** 分析文本中是否完整覆盖了“需求挖掘”、“价值呈现”、“缔结下一步”等核心销售议程。
    - **高频异议类型:** 聚合所有通话，统计客户常见的异议关键词（如“太贵”“没兴趣”“以后再说”），并对应到具体环节。

  - **1.2.4. 综合归因结论**

    - 请用一段流畅、概括性的语言，将1.2.1（沟通风格）、1.2.2（价值共鸣）、1.2.3（流程阻力）的发现串联起来，形成一个高度凝练的综合性归因判断。请不要使用固定的模板句式，确保语言的专业性和独特性。



**2. 销售流程健康度与失败模式诊断**

- **2.1. 通话终局模式与流失点归因**

  - **核心诊断:** 分析所有有效通话文本的最终走向，并从“流失通话文本”中提炼出导致沟通失败的**关键行为模式**，而非简单归因于某个流程阶段。

  - **2.1.1. 通话终局分布 (现状量化)**:
    - 将所有有效通话文本按最终结果分为三类，并计算其占比：
      1. **成功缔结:** 客户明确同意下一步安排（如预约会议、同意接收报价等）。
      2. **进入考虑:** 客户未明确拒绝，但以“发资料我看看”、“我需要考虑一下”等方式结束，未承诺具体行动。
      3. **明确拒绝:** 客户在通话文本中明确表示“没兴趣”、“不需要”、“别再打了”等。

  - **2.1.2. 关键流失模式诊断与命名**
    - **核心任务:** 综合所有“文本片段”的共性，**识别、提炼并命名**导致沟通失败的最核心的行为模式。**你必须自己创造一个能精准概括该模式的名称**，而不是从任何预设列表中选择。

    - **思考与执行路径 (你的内心思考过程应遵循此路径):**
      1.  **第一步：聚合与观察。** 全面回顾所有未能达成目标的文本片段。它们最常在哪个环节“死亡”？客户在挂断或表达拒绝前，顾问通常正在做什么？说的最后一句话是什么类型的？
      2.  **第二步：抽象与归因。** 将观察到的现象抽象成一个具体的、可重复的**顾问行为**。这个行为是关于“说什么”（内容问题），“怎么说”（方式问题），还是“何时说”（时机问题）？将这个核心行为与客户的负面反馈（如失去耐心、表达异议、直接挂断）建立直接的因果关系。
      3.  **第三步：创造与命名。** 基于第二步的抽象结果，为这个核心失败行为模式，**创造一个高度凝练、形象且专业的名称**。这个名称本身就应该能揭示问题的本质。
          - **命名灵感 (仅用于启发思路，严禁直接选用):** 思考这个行为最像生活中的什么场景？可以用什么比喻来形容？例如：“事实轰炸，价值真空”、“无的放矢的提问”、“过早的底牌”、“绕圈式开场”等等。**这些仅仅是启发你思路的例子，你必须根据本次的实际数据，独立创造一个全新的、最贴切的名称。**
      4.  **第四步：阐述与论证 (这是你需要写入报告的内容)。**
          - **模式名称:** 【在此处填写你创造的模式名称】
          - **模式描述:** 详细解释这个模式的具体表现形式（从所有流失通话中，识别并总结出 **1-2种** 导致客户拒绝或拖延的、反复出现的**顾问行为模式**。）。
          - **失败归因:** 清晰论述该模式是如何一步步导致客户兴趣下降、产生抗拒，并最终导致通话失败的。

  - **2.1.3. 诊断结论**:
    - 基于提炼出的关键失败模式，形成最终诊断。
    - **示例诊断:** “当日 `XX%` 的通话以拒绝或拖延告终。其中，最主要的失败模式是‘**自嗨式呈现**’：顾问在挖掘到客户需求后，并未将产品价值与之对应，而是进行了大段的功能罗列，导致 `YY%` 的客户在价值呈现环节表现出明显的不耐烦并最终拒绝。因此，**如何将产品功能与客户具体需求场景化地结合**，是当前最核心的业绩瓶颈。”

- **2.2. 关键失败模式解构与优化策略**

  - **核心诊断:** 本节不再分析某个预设的“环节”。而是直接承接 `2.1` 中识别出的**首要“失败模式”** ，对其进行深度解构，并提供一个可直接执行的、针对性的**“正向行为模式”**作为解决方案。

  - **2.2.1. 失败模式的“负面案例”解构**:

    - **诊断任务:** 在 `{{consultant_daily_calls}}` 中，找到一个能典型体现该“失败模式”的【对话文本片段】作为负面案例。

    - **模式解构:** 简要分析该案例中的顾问行为，指出其是如何体现出该失败模式的，以及它给客户带来了什么样的负面感受。

    - **示例诊断 :**

      > **【负面案例】**
      > **顾问:** “...所以我们这个CRM系统，它用了最新的微服务架构，支持高并发，而且我们有非常灵活的API接口，可以对接你们的ERP和财务软件...”
      > **客户:** “哦...好的，了解了。” (语气变得疏远)
      >
      > **模式解构:** 在这个片段中，顾问在客户并未提问技术细节的情况下，单方面输出了大量技术术语和功能特性（“微服务”、“高并发”、“API接口”），这种沟通方式让客户感到困惑和无聊，因为这与他的实际业务问题（如“如何提升销售转化率”）完全脱节。

  - **2.2.2. 优化策略与“正向模式”建议**:

    - **诊断任务:** 针对上述负面案例，设计并命名一个**“正向行为模式”**作为解决方案，并重塑话术。
    - **优化方向:** `[根据失败模式，提出核心优化原则。]`
    - **正向模式与话术重塑:**
      - **建议的正向模式:** `[为优化的行为模式命名，例如：“‘需求-价值’桥接模式”]`
      - **话术重塑与对比:**
        - **负面案例话术:** “...我们这个CRM系统，它用了最新的微服务架构，支持高并发...”
        - **优化后话术 (正向示范):** “王总，刚才您提到团队协作效率不高，经常出现撞单的情况。我们系统的‘客户锁定’功能就是为了解决这个问题。当一个销售跟进某个客户时，系统会自动锁定，避免其他人重复联系。**这意味着您的团队可以减少内耗，把精力都用在开拓新客户上。** 您觉得这个功能对您有帮助吗？”
        - **优化逻辑:** 这个“‘需求-价值’桥接模式”的核心是：**1. 回顾客户的痛点 (回顾需求) -> 2. 介绍相关功能 (提供方案) -> 3. 翻译成客户能懂的收益 (呈现价值) -> 4. 确认反馈 (引导互动)。** 这确保了每一次功能介绍都精准地回应了客户的需求。



**3. 对话控制力与说服策略诊断**

- **核心诊断:** 深入分析顾问在引导对话走向、处理客户异议和情绪时的具体行为模式，诊断其在“议程主导”和“情绪影响”两个高阶维度上的表现。

- **3.1. 对话议程主导权诊断**

  - **诊断任务:** 分析顾问在对话中是主导议程，还是被客户问题牵着走。重点观察当客户提出偏离核心销售流程（如过早问价、询问不相关细节）的问题时，顾问的反应模式。

  - **关键行为模式诊断:**

    - 在 `{{consultant_daily_calls}}` 中，找到一个最能体现顾问议程控制能力的【文本片段】。
    - 基于该片段，判断并描述顾问当前的议程控制模式，并对其命名。

  - **策略优化与话术示范:**

    - **诊断结论:** `[基于上述片段，形成对顾问议程控制能力的具体诊断]`

    - **优化方向:** `[例如：从“被动问答”升级为“先认可、再引导”的“议程掌控者”]`

    - **话术重塑与示范 (必须基于找到的实际案例进行):**

      - **示例诊断:** “在 `[此处引用案例]` 中，当客户过早询问价格时，顾问立刻陷入了被动的报价和解释，完全偏离了挖掘需求的议程，体现了典型的‘**被动应答模式**’。”

      - **优化后话术 (正向示范):**

        > **客户:** “你们这个系统大概多少钱一年？”
        > **顾问 (优化后):** “王总，价格问题非常关键，我保证稍后会给您一个最透明的报价。不过，为了确保我推荐给您的方案是最适合您、性价比最高的，您能允许我再花三分钟了解一下您目前团队的使用情况吗？这样我的报价才会对您更有意义。您看可以吗？”

      - **优化逻辑:** 这套“**认可 + 价值置换 + 获取许可**”的组合拳，既没有回避客户问题（认可），又成功地将议程拉回到价值挖掘上（引导），重新夺回了主导权。

- **3.2. 关键时刻情绪影响力诊断**

  - **诊断任务:** 诊断顾问在面对客户负面情绪（如质疑、抱怨、不耐烦）时的第一反应和处理能力。

  - **关键行为模式诊断:**

    - 在 `{{consultant_daily_calls}}` 中，找到一个客户表现出明显负面情绪的【文本片段】。
    - 分析并命名顾问在该片段中的情绪处理模式（例如：“事实反驳模式”、“直接道歉模式”或“共情化解模式”）。

  - **策略优化与话术示范:**

    - **诊断结论:** `[基于上述片段，形成对顾问情绪处理能力的具体诊断]`

    - **优化方向:** `[例如：从“习惯性反驳”升级为“先处理心情，再处理事情”]`

    - **话术重塑与示范 (必须基于找到的实际案例进行):**

      - **示例诊断:** “在 `[此处引用案例]` 中，当客户抱怨‘你们系统听起来太复杂了’时，顾问立刻反驳‘其实不复杂，我们的操作很简单’，这体现了‘**事实反驳模式**’，容易激发客户的对抗情绪。”

      - **优化后话术 (正向示范):**

        > **客户:** “你们这个系统听起来也太复杂了吧！”
        > **顾问 (优化后):** “谢谢您这么坦诚地告诉我您的感受，王总。**我完全理解，当接触一个新系统时，最担心的就是上手难度。** 您能具体说说是哪个部分让您感觉复杂了吗？是功能设置，还是日常操作？”

      - **优化逻辑:** 优化后的回应核心在于**情绪缓冲**。第一句“谢谢...我完全理解...”是100%处理情绪，让客户感觉被倾听和尊重。在情绪降温后，再通过提问将问题具体化，从而将一个模糊的抱怨转化成一个可以解决的具体问题。



### **第二部分：双重视角战略发展建议**

*此部分基于第一部分的动态诊断，为销售顾问本人和其管理者提供高度定制化的解读和行动方案。*

### **[CRITICAL_LINKAGE_RULE]: 分析与建议的逻辑一致性强制指令**

**在生成本部分的所有内容前，你必须严格遵守以下规则，以确保分析与建议之间不存在逻辑矛盾：**

1. **核心原则**: 第二部分的所有建议，都**必须**直接源自并服务于第一部分诊断出的**“核心失败模式” (`1.2`)** 和作为证据的**“负面案例” (`1.3`)**。
2. **闪光点 (`4.1`) 约束**: **严禁**将第一部分已诊断出的核心短板（即与“核心失败模式”相关的行为）作为“今日闪光点”进行表扬。闪光点必须是顾问在**其他方面**真实存在的、且未被诊断为核心问题的优势。
3. **能力雷达图 (`4.2`) 约束**: 雷达图评分**必须**客观反映第一部分的分析。与“核心失败模式”最直接相关的那个能力维度，**必须**获得当日的最低分。
4. **核心成长杠杆 (`4.3`) 约束**: “核心成长杠杆”**必须**是、且只能是雷达图中得分最低、且与“核心失败模式”直接对应的那个能力维度。这是整份报告建议部分的绝对核心。
5. **辅导策略 (`5.2`) 约束**: “精准辅导策略卡”中的演练场景，**必须**基于第一部分发现的那个**“负面案例” (`1.3`)** 进行改编和重塑，**严禁**使用任何预设的、通用的场景库。

**现在，请遵循以上强制指令，继续生成报告的剩余部分。**

------

### **4. 致销售顾问：个人成长手册**

#### **4.1. 今日闪光点**

- **关键优势行为:** 聚焦于当日通话中体现出的、最值得保持和放大的**2个核心优势**（例如：“在客户表达初步兴趣后，能非常流畅地通过‘为了让...’的句式来设定后续议程”）。
- **正向影响解读:** 简要说明该优势行为为何有效，及其对销售结果的积极影响，并引用一个**【正面案例片段】**作为证据。

#### **4.2. 个人能力评估 & 解读**

- **核心任务:** 基于整体分析，对顾问在五个核心维度的能力进行量化评分（1-10分），并提供言简意赅的评分依据。评分的目的是为了直观地暴露短板，而不是全盘否定。

- **评分规则与执行路径:**

  1.  **第一步：识别核心短板。** 首先，明确本次分析中最需要改进的核心维度。这个维度必须与你在 `2.1.2` 部分诊断出的“关键流失模式”严格对应。（例如，如果模式是“自嗨式呈现”，那么核心短板维度就是“价值呈现”）。
  2.  **第二步：应用差异化评分。**
      - **对于核心短板维度：** 这是唯一可以低于5分的维度。你可以根据其严重程度，给出一个2-4分的低分，以在雷达图上形成明显的“凹陷”，突出问题的焦点。
      - **对于所有其他非短板维度：** **评分的最低基准线必须为5分。** 5分代表“及格”，意味着顾问在这些方面的表现没有造成重大失误。你可以根据实际数据，在**5分到8分**的区间内进行评分，以体现其“合格但仍有进步空间”的状态。
  3.  **第三步：提供量化依据。** 你必须为每一项评分提供一句话的精炼理由，这个理由需要直接引用你在聚合分析中观察到的行为数据或指标。

- **输出格式:**

  - **开场破冰:** [分数]/10. (依据: [例如：平均开场时长在合理区间，但开场白与客户业务的关联度仅为30%])
  - **需求挖掘:** [分数]/10. (依据: [例如：提问-陈述比为1:3，低于健康的1:1水平])
  - **价值呈现:** [分数]/10. (依据: [例如：超过60%的价值呈现与客户前期需求无关联])
  - **异议处理:** [分数]/10. (依据: [例如：面对价格异议时，仅有25%的通话能拉回价值讨论])
  - **缔结成交:** [分数]/10. (依据: [例如：主动尝试缔结的通话占比为70%，但成功率较低])

- 评估解读与案例穿透:

  - **优势维度解读:** `[指出2个得分最高的维度，并必须引用4.1中的【正面案例片段】来证明为什么这个维度是优势]`

  - **短板维度穿透 (核心):**

    ```
    [指出得分最低的维度，并强制要求你完成以下句子，将其与第一部分的核心诊断关联起来]
    ```

    > “本报告的核心诊断结论是，顾问当前存在‘**[引用1.2中命名的核心失败模式]**’。这一模式在雷达图上最直接的体现就是‘**[此处填写得分最低的维度名称]**’的低分。具体来说，在第一部分我们分析的那个【负面案例】中，顾问 `[简要复述负面案例中的行为]` 的行为，就是导致该项能力得分偏低的直接原因。”

#### **4.3. 核心成长杠杆**

- **核心诊断:** 明确指出在 `4.2` 的雷达图中，哪2项能力的提升能带来**最大的综合业绩回报**。
- **“为什么是它”:** 清晰解释为什么提升这些点至关重要。（例如：“提升‘流程推动力’，就是要解决你‘习惯性接受客户拖延’的失败模式。这能让你出色的‘开场影响力’直接转化为更多有效预约，而不是仅仅停留在一次愉快的聊天。”）

#### **4.4. 明日精进计划**

- **学习任务:** 提供一个高度相关的学习方向（例如：可以多去查阅与“家具”相关的案例信息）。
- **实践任务:** 设计一个可在明日工作中立即应用的**微型实验**，该实验必须是针对“核心失败模式”的直接纠正。（例如：“在明日的前5通电话中，一旦客户说‘我先了解下’，就立即尝试使用‘王总，我完全理解。正是为了让您的了解更高效，我们不妨花15分钟快速演示一下核心功能，这样您就有了一个判断的基准。您看周五上午方便吗？’来主动推进。”）
- **反思问题:** 提出一个引导自我思考的问题，直击“核心失败模式”的思维根源。（例如：“当客户表现出犹豫时，我的第一反应是‘如何让他方便’，还是‘如何推动流程’？”）

------

### **5. 致管理者：精准辅导指南**

#### **5.1. 顾问能力诊断快照**

- **核心优势象限:** 该顾问最突出的、可被团队分享的才干（关联`4.1`）。
- **主要发展短板:** 对其业绩造成最大制约的关键瓶颈（关联`1.2 核心失败模式`）。
- **发展潜力预判:** 基于当前模式，该顾问的可能成长轨迹（例如：“高潜力新人，需加强流程训练”、“稳定的关系维护者，需激发其成交欲望”）。
- **潜在风险提示:** 若短板不被改善，可能出现的负面结果（例如：“通话量高但转化率持续偏低，易产生挫败感”、“可能因害怕被拒绝而错失大量机会”）。

#### **5.2. 精准辅导策略卡**

- **辅导切入点:** 明确建议管理者本次1对1辅导应聚焦的**唯一、最关键的行为**（直接关联 `4.3. 核心成长杠杆`）。

- **辅导方式:** 推荐采用“**真实案例复盘 + 情景重塑 (Role Play)**”。

- 辅导场景构建 (核心指令):

  - **第一步：案例复盘:** 指导管理者与顾问一起回顾第一部分诊断出的那个**【负面案例】**的通话文本记录。

  - **第二步：情景重塑与演练:**

    你必须将那个【负面案例】的对话，改编成一个用于情景模拟 (Role Play) 的剧本。

    剧本需要包含：

    1. **背景设定:** `[简要说明案例发生时的客户背景和对话阶段]`
    2. **模拟开始的触发句:** `[提供客户说出的、触发了顾问“失败模式”的那句话]`
    3. **辅导目标:** 明确指出本次演练的目标，即演练一种新的、更有效的应对方式（引用`1.4`中的优化话术），以取代旧的“核心失败模式”。

- **关键提问示例:** 为管理者提供可以直接使用的、与**所构建场景**高度相关的启发性问题。（例如：“我们回到客户说出‘我先了解下’这一刻，你当时心里在想什么？除了直接接受，我们还有没有第二种、第三种可能的回应方式？”）

- **正向强化要点:** 建议管理者在顾问演练出优化后的话术时，应立即给予肯定和强化，巩固新的行为模式。





### **[EXECUTION_COMMAND]**

现在，请根据以下提供的**顾问日度量化数据**和**日度通话文本记录集合**，严格遵循以上指令，直接生成一份完整的、可直接转换为PDF的 **Markdown格式中文分析报告**。

**顾问日度量化数据 (consultant_daily_metrics):**

- 顾问姓名：
- 日期：
- 总通话数：
- 接通数：
- 接通率（接通数/总通话数）：
- 有效通话字数总量：
- 有效通话率（有效文本≥3轮对话/接通数）：
- 平均有效通话长度（有效文本字数/有效通话次数）：

**顾问日度通话记录 (consultant_daily_calls):**

- 上传文件





### **[OUTPUT_FORMAT]**

# **销售顾问日度表现深度分析报告**

**顾问姓名:** `[顾问姓名]` **分析日期:** `[报告生成日期]`

------

## **第一部分：客观数据与行为模式洞察**

*此部分是对全天表现的纯粹数据驱动的模式分析，是后续双视角解读的基础。*

### **1. 综合效能诊断**

#### **1.1. 核心业绩看板**

| 指标名称         | 今日数据                        |
| :--------------- | :------------------------------ |
| 总通话数         | `[总通话数值]`                  |
| 接通数           | `[接通数值]`                    |
| 接通率           | `[计算出的接通率]%`             |
| 有效通话率       | `[计算出的有效通话率]%`         |
| 平均有效通话时长 | `[计算出的平均有效通话时长]` 秒 |
| 有效通话时长     | `[总有效通话时长]`              |

#### **1.2. 业绩归因分析: 多维诊断**

##### **1.2.1. 对话动态与主导权诊断 (沟通风格画像)**

- 顾问发言占比 (进攻性指标): [计算出的百分比] % (目标区间: 55%-65%)

  - **诊断结论**: 当前发言占比**`[高于/低于/处于]`**理想的“进攻型”区间。沟通模式被初步评估为“**`[根据与目标区间的对比，命名为“进攻型主导”、“压迫式宣讲”或“主导力不足”]`**”。

- 提问-陈述比 (进攻有效性指标):[计算出的比例，如 1:X]



  - **诊断结论**: 结合发言占比，顾问在对话中展现出“**`[根据两个指标综合判断并命名的画像，如：高控场价值输出者/单向产品宣讲师/被动信息接收者]`**”的沟通画像。其进攻的有效性`[高/中/低]`，因为`[具体描述，如：能在高密度陈述中，依然通过关键提问来引导客户，确保了进攻的精准性/几乎完全依赖陈述，缺少必要的互动与确认，导致进攻效率不高/提问过多但缺乏引导性，导致对话发散]`。

##### **1.2.2. 价值传递与客户共鸣诊断 (信息有效性检验)**

- 客户共鸣真实性诊断:

  - **诊断结论**: 在多数对话中，顾问的价值传递更多是换来了客户**`[选择并描述：“礼貌性的附和”或“主动的探究性提问”]`**。这表明，其传递的信息`[选择：“未能真正触动客户”或“成功激发了客户的深度思考”]`。

- 价值传递的“逻辑驱动力”分析:

  - **诊断结论**: 顾问组织价值论述的核心逻辑线，更倾向于是由“**`[选择：“产品功能”或“客户问题”]`**”来驱动的。

  - 沟通模式命名与举例: 这种模式可被命名为“`[AI根据上述判断，命名此模式，如：“功能清单罗列模式”或“痛点-方案响应模式”]`”。

    > **【对话片段】** `[AI在此处引用一段最能体现该模式的对话片段]`
    >
    > **模式描述**: `[AI简要描述该片段如何体现了上述命名的模式及其带来的效果]`

##### **1.2.3. 流程阻力与异议点定位 (执行瓶颈分析)**

- 关键议程覆盖率:  [计算出的百分比]%

  - **诊断结论**: 仅有 `[百分比]`% 的通话完整覆盖了“需求挖掘 -> 价值呈现 -> 缔结下一步”的核心议程，表明大量通话在早期阶段便已中断，流程推进的系统性有待加强。

- 高频异议类型与分布:

  - TOP 3 高频异议:
    1. **`[异议类型1]`** (主要出现在: `[销售环节]`)
    2. **`[异议类型2]`** (主要出现在: `[销售环节]`)
    3. **`[异议类型3]`** (主要出现在: `[销售环节]`)
  - **诊断结论**: 业绩的核心阻力点在于`[根据异议类型和出现环节进行诊断，如：开场吸引力不足导致大量“没兴趣”的异议/价值塑造不足导致“价格异议”过早出现]`。

##### **1.2.4. 综合归因结论**

```
[AI将1.2.1的沟通风格、1.2.2的价值传递逻辑、1.2.3的流程阻力三者串联，形成一段流畅、高度凝练的综合性归因判断，避免使用固定模板句式]
```

### **2. 销售流程健康度与失败模式诊断**

#### **2.1. 通话终局模式与流失点归因**

##### **2.1.1. 通话终局分布**

| 通话最终结果 | 占比                      |
| :----------- | :------------------------ |
| **成功缔结** | `[计算出的成功缔结占比]`% |
| **进入考虑** | `[计算出的进入考虑占比]`% |
| **明确拒绝** | `[计算出的明确拒绝占比]`% |

##### **2.1.2. 关键流失模式诊断 (核心)**

- 失败模式提炼: 在所有“进入考虑”和“明确拒绝”的通话中，导致沟通失败的首要、反复出现的行为模式被诊断为：“`[AI从所有流失通话中，识别、总结并命名一种关键的顾问行为模式，如：“自嗨式呈现”、“盘问式挖掘”或“过早报价”]`”。

  > **【对话片段举例】** `[AI在此处引用一段最能体现该失败模式的对话片段]`
  >
  > **模式描述**: `[AI简要描述该片段如何体现了上述命名的失败模式]`

##### **2.1.3. 诊断结论**

当日 `[“进入考虑”和“明确拒绝”的占比总和]`% 的通话以拒绝或拖延告终。其中，最主要的失败模式是“**`[引用2.1.2中命名的失败模式]`**”。该模式导致 `[描述其具体负面影响，如：大量客户在价值呈现环节表现出不耐烦并最终拒绝]`。因此，**`[用一句话总结当前最核心的业绩瓶颈]`** 是当前需要解决的首要问题。

#### **2.2. 关键失败模式解构与优化策略**

*本节将针对 `2.1.2` 中诊断出的“**`[引用2.1.2中命名的失败模式]`**”进行深度解构与优化。*

##### **2.2.1. 失败模式的“负面案例”解构**

> **【负面案例】** `[AI在此处找到一个最典型的、完整的负面案例对话片段]`
>
> **模式解构**: 在这个片段中，顾问的行为 `[简要分析顾问行为]` 正是“**`[引用2.1.2中命名的失败模式]`**”的典型表现。这种沟通方式给客户带来了 `[描述负面感受，如：困惑、被审问、感觉脱节等]` 的负面感受，并直接导致了 `[描述最终的负面结果，如：客户的拒绝]`。

##### **2.2.2. 优化策略与“正向模式”建议**

- **优化方向**: 从“`[概括失败模式的核心问题，如：功能为中心]`”转向“`[概括优化策略的核心思想，如：客户收益为中心]`”。

- 正向模式与话术重塑:

  - **建议的正向模式命名:** “**`[AI为优化的行为模式命名，如：“‘需求-价值’桥接模式”]`**”

  - 话术重塑与对比:

    - 负面案例话术:

      > `[直接引用2.2.1中负面案例的顾问话术]`

    - 优化后话术 (正向示范):

      > `[AI针对负面案例的话术，进行“手术刀”式修改，并提供优化后的完整话术]`

    - **优化逻辑:** 这个“`[引用正向模式名称]`”的核心是：`[AI用“1. -> 2. -> 3. -> 4.”的格式，清晰地拆解优化后话术的内在逻辑步骤]`。这确保了每一次沟通都精准地回应了客户的需求。

### **3. 对话控制力与说服策略诊断**

#### **3.1. 对话议程主导权诊断**

- 议程控制模式诊断: 顾问当前的议程控制模式被诊断为“`[AI命名该模式，如：“被动应答模式”或“顺滑引导模式”]`”。

  > **【对话片段举例】** `[AI在此处引用一段最能体现该议程控制模式的对话片段，通常是客户提出偏离议程问题时的场景]`
  >
  > **诊断结论**: 在该片段中，当客户 `[描述客户行为]` 时，顾问的反应是 `[描述顾问反应]`，这体现了其在议程控制方面的 `[优势/短板]`。

- 策略优化与话术示范:

  - **优化方向**: 从“被动问答”升级为“先认可、再引导”的“议程掌控者”。

  - 话术重塑 (基于上述案例):

    > `[AI将上述案例中的顾问话术进行优化，展示如何重新夺回主导权]`

  - **优化逻辑**: 采用“**认可 + 价值置换 + 获取许可**”的组合策略，既尊重客户，又将对话拉回核心议程。

#### **3.2. 关键时刻情绪影响力诊断**

- 情绪处理模式诊断: 顾问在面对客户负面情绪时的反应模式被诊断为“`[AI命名该模式，如：“事实反驳模式”或“共情化解模式”]`”。

  > **【对话片段举例】** `[AI在此处引用一段客户表现出负面情绪，以及顾问如何应对的对话片段]`
  >
  > **诊断结论**: 在该片段中，当客户表达 `[描述客户的负面情绪]` 时，顾问的第一反应是 `[描述顾问的应对行为]`，这体现了‘**`[引用情绪处理模式名称]`**’，容易 `[描述该行为可能带来的结果，如：激发对抗情绪或有效化解矛盾]`。

- 策略优化与话术示范:

  - **优化方向**: 从“习惯性反驳”升级为“先处理心情，再处理事情”。

  - 话术重塑 (基于上述案例):

    > `[AI将上述案例中的顾问话术进行优化，展示如何先进行情绪缓冲]`

  - **优化逻辑**: 优化后的回应核心在于**情绪缓冲**。通过“**共情认可 + 引导探寻**”的步骤，先让客户感觉被理解，再将模糊抱怨转化为具体问题。

------

## **第二部分：双重视角战略发展建议**

*此部分基于第一部分的动态诊断，为销售顾问本人和其管理者提供高度定制化的解读和行动方案。*

### **4. 致销售顾问：个人成长手册**

#### **4.1. 今日闪光点**

- 关键优势行为:

  ```
  [AI聚焦于当日通话中体现出的、与核心短板无关的1-2个核心优势行为]
  ```

  > **【正面案例片段】** `[AI引用一个能证明该优势的正面案例片段作为证据]`

- **正向影响解读:** `[AI简要说明该优势行为为何有效，及其对销售结果的积极影响]`

#### **4.2. 个人能力评估 & 解读**

- **开场影响力**: `[1-10分]`
- **需求洞察力**: `[1-10分]`
- **价值说服力**: `[1-10分]`
- **异议控制力**: `[1-10分]`
- **流程推动力**: `[1-10分]`

**雷达图解读与案例穿透**:

- **优势维度解读:** 本日得分最高的维度是“**`[得分最高的维度名称]`**”。在【正面案例片段】中，你 `[简述正面案例中的行为]` 的行为，正是这项能力的体现。

- 短板维度穿透 (核心):

  > “本报告的核心诊断结论是，顾问当前存在‘**`[引用2.1.2中命名的失败模式]`**’。这一模式在雷达图上最直接的体现就是‘**`[得分最低的维度名称]`**’的低分。具体来说，在第一部分我们分析的那个【负面案例】中，顾问 `[简要复述2.2.1负面案例中的行为]` 的行为，就是导致该项能力得分偏低的直接原因。”

#### **4.3. 核心成长杠杆**

- **核心成长杠杆**: **`[得分最低的维度名称]`**
- **“为什么是它”**: 提升“**`[得分最低的维度名称]`**”至关重要，因为它正是为了解决你“**`[引用2.1.2中命名的失败模式]`**”的失败模式。`[AI清晰解释提升这一点将如何克服失败模式，并带来连锁反应]`。

#### **4.4. 明日精进计划**

- **学习任务**: `[提供一个与“核心失败模式”高度相关的学习方向]`。
- **实践任务**: 设计一个针对“**`[引用2.1.2中命名的失败模式]`**”的微型实验：`[AI设计一个可在明日工作中立即应用的、具体的、可衡量的实践任务]`。
- **反思问题**: `[AI提出一个直击“核心失败模式”思维根源的引导性问题]`。

------

### **5. 致管理者：精准辅导指南**

#### **5.1. 顾问能力诊断快照**

- **核心优势象限**: `[总结顾问最突出的、可被团队分享的才干，关联4.1]`。
- **主要发展短板**: `[总结对其业绩造成最大制约的关键瓶颈，关联2.1.2的核心失败模式]`。
- **发展潜力预判**: `[基于当前模式，给出顾问的可能成长轨迹预判]`。
- **潜在风险提示**: `[说明若短板不被改善，可能出现的负面结果]`。

#### **5.2. 精准辅导策略卡**

- **辅导切入点**: 本次1对1辅导，建议唯一聚焦于解决“**`[引用2.1.2中命名的失败模式]`**”，提升其“**`[引用4.3的核心成长杠杆]`**”能力。
- **辅导方式**: 推荐采用“**真实案例复盘 + 情景重塑”。
- 辅导场景构建 (核心指令):
  - **第一步：案例复盘:** 指导管理者与顾问一起回顾第一部分 `2.2.1` 中诊断的那个**【负面案例】**。
  - **第二步：情景重塑与演练:**
    - **背景设定:** `[AI简要说明2.2.1中负面案例发生时的客户背景和对话阶段]`。
    - **模拟开始的触发句 (客户说):** “`[AI提供客户说出的、触发了顾问“失败模式”的那句话]`”
    - **辅导目标:** 本次演练的目标，是练习使用 `2.2.2` 中建议的“**`[引用2.2.2中正向模式的名称]`**”话术，有效应对上述场景，取代旧的失败模式。
- **关键提问示例**: `[AI为管理者提供1-2个可以直接使用的、与所构建场景高度相关的启发性问题]`。
- **正向强化要点**: 建议管理者在顾问演练出优化后的话术时，应立即给予肯定，并强化 `2.2.2` 中提到的**优化逻辑**，确保顾问知其然，更知其所以然。
"""




def analyze_consultant_with_ai(consultant_name, report_date, daily_metrics, all_transcripts):
    """使用AI分析顾问总体情况"""

    # 构建顾问日度量化数据字符串
    metrics_str = f"""
顾问姓名：{consultant_name}
日期：{report_date}
总通话数：{daily_metrics['call_count']}
接通数：{daily_metrics['connected_calls']}
接通率：{daily_metrics['connection_rate']}
有效通话数：{daily_metrics['effective_calls']}
有效通话率：{daily_metrics['effective_call_rate']}
平均有效通话时长：{daily_metrics['average_effective_duration']}
有效通话总时长：{daily_metrics['total_effective_duration_minutes']} 分钟
"""

    # 构建所有通话记录字符串
    calls_str = "\n\n".join([f"通话{i + 1}：\n{transcript}" for i, transcript in enumerate(all_transcripts)])

    # 替换提示词中的占位符
    prompt = SECONDARY_ANALYSIS_PROMPT.replace("{{consultant_daily_metrics}}", metrics_str)
    prompt = prompt.replace("{{consultant_daily_calls}}", calls_str)

    url = "https://api2.aigcbest.top/v1/chat/completions"
    api_key = "sk-h9JKULx7zU2K2fTligKXsAPRYFs0q2E7i9WeyDsnUskVav5n"
    headers = {"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}
    payload = {
        "model": "gpt-4.1",
        "messages": [
            {"role": "user", "content": prompt}
        ],
        "temperature": 0,
        "max_tokens": 32768  # 增加token限制以获取完整分析
    }

    for attempt in range(3):

        try:
            r = requests.post(url, headers=headers, json=payload, timeout=120)
            if r.status_code != 200:
                if r.status_code in (429,) or 500 <= r.status_code < 600:
                    time.sleep(2 ** attempt)
                    continue
                return None, f"分析失败 {r.status_code}: {r.text}"

            data = r.json()
            content = data.get("choices", [{}])[0].get("message", {}).get("content", "")

            return content, ""

        except Exception as e:
            time.sleep(2 ** attempt)
            last = str(e)

    return None, f"分析异常: {last}"


def markdown_to_pdf(markdown_content: str, output_path: str) -> bool:
    """
    将Markdown内容转换为PDF文件，直接使用Markdown的格式，不添加多余操作。
    """
    if not PDF_AVAILABLE:
        print("PDF转换功能不可用，请安装 markdown 和 weasyprint 包")
        return False
        
    try:
        # 1. 将Markdown转换为HTML
        # 使用'extra'和'codehilite'扩展以支持表格、脚注和代码高亮
        html_body = markdown.markdown(markdown_content, extensions=['extra', 'codehilite'])

        # 2. 构建一个包含基本样式的完整HTML文档
        # 这里的CSS是为了确保PDF有基本的排版和可读性，例如字体、行高、边距、代码块样式等。
        # 它不包含复杂的布局或自定义元素，力求保持Markdown的"原始"渲染。
        full_html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>顾问分析报告</title>
            <style>
                /* 基本的Reset和通用样式 */
                body {{
                    font-family: "Noto Sans CJK SC", "Source Han Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
                    line-height: 1.6;
                    margin: 2cm; /* 页面边距 */
                    color: #333;
                }}
                h1, h2, h3, h4, h5, h6 {{
                    color: #2c3e50;
                    margin-top: 1em;
                    margin-bottom: 0.5em;
                }}
                h1 {{ font-size: 2.2em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }}
                h2 {{ font-size: 1.8em; }}
                h3 {{ font-size: 1.4em; }}
                h4 {{ font-size: 1.2em; }}
                p {{ margin-bottom: 1em; }}
                a {{ color: #3498db; text-decoration: none; }}
                a:hover {{ text-decoration: underline; }}

                /* 列表样式 */
                ul, ol {{
                    margin-left: 2em;
                    margin-bottom: 1em;
                }}
                ul li {{ list-style-type: disc; }}
                ol li {{ list-style-type: decimal; }}

                /* 代码块样式 */
                pre {{
                    background-color: #f6f8fa;
                    border-radius: 3px;
                    padding: 1em;
                    overflow-x: auto; /* 防止代码过长溢出 */
                    font-family: 'Courier New', Courier, monospace;
                    font-size: 0.9em;
                    margin-bottom: 1em;
                }}
                code {{
                    font-family: 'Courier New', Courier, monospace;
                    background-color: #f0f0f0;
                    padding: 0.2em 0.4em;
                    border-radius: 3px;
                    font-size: 0.9em;
                }}
                pre code {{
                    background-color: transparent; /* 代码块内的code不显示单独背景 */
                    padding: 0;
                }}

                /* 表格样式 */
                table {{
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 1em;
                }}
                th, td {{
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: left;
                }}
                th {{
                    background-color: #f2f2f2;
                    font-weight: bold;
                }}

                /* 引用块样式 */
                blockquote {{
                    border-left: 4px solid #ccc;
                    padding-left: 1em;
                    margin-left: 0;
                    color: #555;
                    font-style: italic;
                    margin-bottom: 1em;
                }}

                /* 图片样式 */
                img {{
                    max-width: 100%; /* 确保图片不会超出页面宽度 */
                    height: auto;
                    display: block; /* 居中图片 */
                    margin: 1em auto;
                }}

                /* 水平线 */
                hr {{
                    border: 0;
                    border-top: 1px solid #eee;
                    margin: 2em 0;
                }}
            </style>
        </head>
        <body>
            {html_body}
        </body>
        </html>
        """

        # 3. 使用WeasyPrint将HTML转换为PDF
        # 可以选择性地传递CSS文件，这里我们把CSS内联到HTML中
        HTML(string=full_html).write_pdf(output_path)

        return True
    except Exception as e:
        print(f"❌ PDF转换失败: {e}")
        return False


def save_consultant_analysis(consultant_name, analysis_content, report_date):
    """保存顾问分析报告"""
    try:
        # 创建输出目录 - 当前工作目录下/consultant_analysis_output/当前日期
        today = datetime.now().strftime('%Y-%m-%d')
        output_dir = os.path.join("consultant_analysis_output", today)
        if not os.path.exists(output_dir):
            os.makedirs(output_dir, exist_ok=True)
        
        # 生成文件名
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        md_filename = f"{consultant_name}_顾问分析报告_{report_date}_{timestamp}.md"
        pdf_filename = f"{consultant_name}_顾问分析报告_{report_date}_{timestamp}.pdf"
        
        md_path = os.path.join(output_dir, md_filename)
        pdf_path = os.path.join(output_dir, pdf_filename)
        
        # 保存Markdown报告
        with open(md_path, 'w', encoding='utf-8') as f:
            f.write(analysis_content)
        
        print(f"顾问分析报告已保存到: {md_path}")
        
        # 转换为PDF
        if markdown_to_pdf(analysis_content, pdf_path):
            print(f"PDF报告已生成: {pdf_path}")
            return pdf_path
        else:
            print("PDF转换失败，仅保存了Markdown文件")
            return md_path
        
    except Exception as e:
        print(f"保存顾问分析报告失败: {e}")
        return None


def analyze_consultant_data(consultant_name, report_date, adviser_data, daily_metrics):
    """
    分析顾问数据并生成报告
    
    Args:
        consultant_name: 顾问姓名
        report_date: 报告日期
        adviser_data: 顾问数据，包含以下字段：
            - total_calls: 总通话数
            - calls: 通话记录列表，每个记录包含：
                - record_id: 记录ID
                - customer_id: 客户ID
                - phone: 电话号码
                - call_time: 通话时间
                - duration_seconds: 通话时长（秒）
                - file_url: 录音文件URL
                - remark: 备注
                - transcript: 转写内容（可选）
        daily_metrics: 从数据库获取的日度量化指标
    
    Returns:
        tuple: (analysis_content, error_message)
    """
    if adviser_data["total_calls"] == 0:
        return None, "无通话记录"

    # 收集所有转写内容，选择10条最长的
    all_transcripts = []
    for call in adviser_data["calls"]:
        if call.get("transcript"):
            all_transcripts.append(call["transcript"])
    
    # 按长度排序，选择最长的10条
    all_transcripts.sort(key=len, reverse=True)
    all_transcripts = all_transcripts[:10]
    
    if not all_transcripts:
        return None, "无转写内容"
    
    # 使用AI进行综合分析
    analysis_content, error = analyze_consultant_with_ai(
        consultant_name,
        report_date,
        daily_metrics,
        all_transcripts
    )
    
    return analysis_content, error
